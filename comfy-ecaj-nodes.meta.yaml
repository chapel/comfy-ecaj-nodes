kynetic_meta: "1.0"
agents:
  - _ulid: 01KH4D20YRV8MXAEMAC70AKQQZ
    id: claude
    name: Claude Code Agent
    description: Primary development agent for this project.
    capabilities:
      - code
      - test
      - refactor
      - review
    tools:
      - kspec
      - git
      - uv
    conventions: []
workflows:
  - _ulid: 01KH4D2G8XEYKRQNNZR9HC6S8A
    id: task-work-session
    trigger: manual
    description: Core pattern for working on a task. Full lifecycle from start through PR merge.
    steps:
      - type: check
        content: |-
          Check for existing in_progress or pending_review tasks.
          Use: kspec session start (shows active work first)
          Priority: pending_review > in_progress > ready
        on_fail: Inherit existing work instead of starting new.
      - type: action
        content: |-
          Choose task to work on.
          Use: kspec tasks ready to see available tasks
      - type: check
        content: |-
          Verify work is not already done.
          Check git history and existing code.
        on_fail: Mark task complete with Already implemented reason
      - type: action
        content: |-
          Start the task.
          Use: kspec task start @task
      - type: action
        content: |-
          Work on the task, adding notes as you go.
          Use: kspec task note @task "What you are doing..."
      - type: check
        content: All changes committed
        on_fail: "Commit changes with Task: @task trailer."
      - type: action
        content: |-
          Submit task for review.
          Use: kspec task submit @task
      - type: action
        content: |-
          Create PR.
          Use: /pr skill or gh pr create
  - _ulid: 01KH4D2XWDYBF7V5FW6GA497JC
    id: session-reflect
    trigger: session-end
    description: Structured reflection after work sessions. Surfaces learnings, identifies friction, and
      captures improvements.
    steps:
      - type: action
        content: |-
          Identify what worked well this session.
          Be specific. Consider: workflows, tools, communication, decisions.
      - type: action
        content: |-
          Identify friction points - where things were harder than needed.
          Focus on systemic issues, not one-off mistakes.
      - type: action
        content: |-
          Check if friction points are already tracked.
          Search specs, tasks, AND inbox before proposing new improvements.
      - type: action
        content: |-
          For untracked friction, propose concrete improvements.
          Include: what it would do, how it helps, rough scope.
      - type: decision
        content: Present findings to user - ask about each improvement one at a time
        options:
          - Worth capturing -> proceed to capture
          - Needs refinement -> discuss and refine
          - Not worth it -> skip
          - Done with reflection -> complete workflow
      - type: action
        content: |-
          Capture approved items:
          - Actionable improvements: kspec inbox add
          - Friction patterns: kspec meta observe friction
          - Success patterns: kspec meta observe success
          - Open questions: kspec meta question add
  - _ulid: 01KH4D3C8G9G78XHVVJXB0B874
    id: pr-review-merge
    trigger: pr-merge
    description: Quality gate for reviewing and merging PRs. Ensures all CI passes, reviews addressed,
      and threads resolved before merge.
    steps:
      - type: check
        content: All CI checks complete (none pending or running)
        on_fail: Wait for CI to finish. Do not merge while checks are running.
      - type: check
        content: All CI checks pass (green)
        on_fail: Fix failures, push changes, wait for CI to re-run and pass.
      - type: action
        content: |-
          Read ALL review comments on the PR.
          Use: gh pr view --comments or GitHub UI
      - type: check
        content: All review feedback addressed
        on_fail: Fix each issue raised by reviewers. Push changes and wait for re-review if needed.
      - type: action
        content: |-
          Check for @claude mentions or other requests in comments.
          Complete any actions the PR agent could not.
      - type: check
        content: All requested actions completed
        on_fail: Complete the actions yourself before proceeding.
      - type: check
        content: All review threads resolved in GitHub UI
        on_fail: Click Resolve conversation on each thread after addressing.
      - type: decision
        content: Ready to merge?
        options:
          - Yes - all checks green, all reviews addressed, all threads resolved
          - No - need user approval to merge with known issues
          - Skip - user explicitly said to merge anyway
      - type: action
        content: |-
          Merge the PR.
          Use: gh pr merge (prefer merge commit to preserve trailers)
  - _ulid: 01KH4D3QHJSWS40QETS1K5ER2N
    id: inbox-triage
    trigger: session-start
    description: Systematic processing of inbox items into specs and tasks.
    steps:
      - type: action
        content: |-
          Get context and list inbox items.
          Use: kspec session start --full
          Use: kspec inbox list
      - type: action
        content: |-
          Categorize items by type:
          - Bugs
          - Spec gaps
          - Quick wins
          - Larger features (need plan mode)
          - Delete candidates
      - type: decision
        content: Process each item - is it still relevant?
        options:
          - No -> delete it
          - Yes, spec exists -> promote to task
          - Yes, need spec -> create spec first
          - Unclear -> leave for later
      - type: action
        content: |-
          For behavior changes, follow spec-first approach:
          1. Check if spec covers the change
          2. Create or update spec with AC if needed
          3. Derive task or promote inbox item
  - _ulid: 01KH4D44TWNR22J821DBRS9YPV
    id: local-review
    trigger: manual
    description: Quality enforcement for pre-PR review. Verifies AC coverage with annotations, test
      quality, and test isolation.
    steps:
      - type: action
        content: |-
          Get spec reference and read acceptance criteria.
          Use: kspec item get @spec to see ACs
          Each AC needs test coverage.
      - type: check
        content: |-
          Every AC has test coverage with AC annotation.
          Search tests for: # AC: @spec-ref ac-N
        on_fail: "MUST-FIX: Missing AC coverage is a blocking issue."
      - type: check
        content: |-
          All tests validate real behavior (no fluff tests).
          Tests should fail if the feature breaks.
        on_fail: "MUST-FIX: Identify and flag fluff tests."
      - type: check
        content: |-
          Tests are properly isolated.
          No shared mutable state across tests.
          Fresh fixtures for each test case.
        on_fail: "MUST-FIX: Tests must be properly isolated."
      - type: action
        content: |-
          Report findings.
          List all MUST-FIX issues that block PR creation.
          Non-blocking suggestions can be noted separately.
  - _ulid: 01KH4D4MGKTBM16W1NFT9TMQJS
    id: pr-review-loop
    trigger: loop-pr-review
    description: PR review subagent workflow for loop mode. Runs local review, verifies AC coverage and
      spec alignment, fixes issues, waits for CI, and merges with quality gates.
    steps:
      - type: action
        content: |-
          Run local review workflow first.
          Use: /local-review skill
      - type: check
        content: |-
          Verify all spec ACs linked to task have test coverage.
          Check test files for AC annotations.
        on_fail: Add missing test coverage before continuing.
      - type: check
        content: |-
          Verify implementation matches spec requirements.
          Read spec, read implementation, compare.
        on_fail: Fix misalignment between spec and implementation.
      - type: decision
        content: Evaluate local-review findings.
        options:
          - MUST-FIX issues, can fix -> Fix and continue
          - MUST-FIX issues, cannot fix -> Mark needs_review, EXIT
          - Only advisory issues -> Continue with merge
          - No issues -> Continue with merge
      - type: action
        content: Push changes (if any fixes were made).
      - type: check
        content: |-
          Wait for CI to complete and pass.
          CRITICAL: Re-verify CI after ANY push.
        on_fail: "If CI fails: investigate, fix, push, return to this step."
      - type: action
        content: |-
          Post review summary as PR comment.
          Use: gh pr comment
      - type: action
        content: |-
          Follow PR review merge gates.
          Use: kspec workflow start @pr-review-merge
      - type: check
        content: Verify PR was successfully merged.
        on_fail: Check for conflicts or protection rules.
      - type: action
        content: |-
          Mark task completed with PR reference.
          Use: kspec task complete @task --reason "Merged in PR #N"
conventions: []
observations: []
includes: []
