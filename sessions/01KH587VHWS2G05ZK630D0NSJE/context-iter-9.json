{
  "generated_at": "2026-02-11T03:16:59.508Z",
  "branch": "feat/batched-executor",
  "context": {
    "focus": null,
    "threads": [],
    "open_questions": [],
    "updated_at": "2026-02-11T03:16:59.508Z"
  },
  "active_tasks": [],
  "pending_review_tasks": [
    {
      "ref": "01KH4HA47F",
      "title": "Implement Batched Pipeline Executor",
      "started_at": "2026-02-11T03:11:31.166Z",
      "priority": 2,
      "spec_ref": "@batched-executor",
      "note_count": 3,
      "last_note_at": "2026-02-11T03:15:35.069Z",
      "todo_count": 0,
      "incomplete_todos": 0
    }
  ],
  "recent_notes": [
    {
      "task_ref": "01KH4HA47F",
      "task_title": "Implement Batched Pipeline Executor",
      "task_status": "pending_review",
      "note_ulid": "01KH5B4X",
      "created_at": "2026-02-11T03:15:35.069Z",
      "author": "@claude",
      "content": "Implemented batched pipeline executor primitives in lib/executor.py. Created OpSignature (frozen dataclass for parameter grouping by shape/affecting_sets), DeltaSpec (LoRA delta specification), compile_batch_groups (groups keys by OpSignature), compute_batch_size (targets 70% free VRAM), apply_lora_batch_gpu (torch.bmm for standard LoRA, torch.kron for LoKr), and chunked_evaluation (OOM backoff wrapper with CPU result transfer and dtype matching). All 7 ACs covered by 30 tests: AC-1 (grouping), AC-2 (bmm), AC-3 (70% VRAM), AC-4 (OOM backoff), AC-5 (CPU results), AC-6 (dtype matching), AC-7 (LoKr kron). All 215 tests pass, ruff clean."
    },
    {
      "task_ref": "01KH4HA473",
      "task_title": "Implement Exit Patch Installation",
      "task_status": "completed",
      "note_ulid": "01KH5AQ1",
      "created_at": "2026-02-11T03:08:01.142Z",
      "author": "@claude",
      "content": "Implemented install_merged_patches() helper and IS_CHANGED classmethod. install_merged_patches clones ModelPatcher, builds set patches with diffusion_model. prefix, transfers tensors to CPU and casts to base dtype. IS_CHANGED walks recipe tree to collect LoRA paths, computes SHA-256 hash from (path, mtime, size) tuples for cache key. All 6 ACs covered by 26 tests: AC-1 (clone and set patches), AC-2 (diffusion_model. prefix), AC-3 (CPU transfer), AC-4 (dtype matching), AC-5 (identical hash on no changes), AC-6 (different hash on modifications). All 185 tests pass, ruff clean."
    },
    {
      "task_ref": "01KH4HA46D",
      "task_title": "Implement Merge Node",
      "task_status": "completed",
      "note_ulid": "01KH5ABP",
      "created_at": "2026-02-11T03:01:49.105Z",
      "author": "@claude",
      "content": "Implemented Merge node with base/target type validation. merge() validates base is RecipeBase or RecipeMerge (rejects RecipeLoRA/RecipeCompose with helpful error), accepts RecipeLoRA/RecipeCompose/RecipeMerge as target. All 6 ACs covered by 23 tests: AC-1 (returns RecipeMerge with fields), AC-2 (no backbone defaults None), AC-3 (backbone stored when provided), AC-4 (merge chaining via base), AC-5 (RecipeLoRA/RecipeCompose rejected as base), AC-6 (t_factor -1.0 preserved). All 159 tests pass, ruff clean."
    },
    {
      "task_ref": "01KH4HA46A",
      "task_title": "Implement Compose Node",
      "task_status": "completed",
      "note_ulid": "01KH5A2D",
      "created_at": "2026-02-11T02:56:45.530Z",
      "author": "@claude",
      "content": "Implemented Compose node with branch validation and chaining. compose() uses RecipeCompose.with_branch() for persistent semantics. Added 17 tests covering all 4 ACs: AC-1 (single branch returns single-element tuple), AC-2 (appends to existing compose), AC-3 (three chained nodes in order), AC-4 (RecipeBase rejected with helpful error). Also validates compose input is RecipeCompose. All 136 tests pass, ruff clean."
    },
    {
      "task_ref": "01KH4HA467",
      "task_title": "Implement LoRA Node",
      "task_status": "completed",
      "note_ulid": "01KH59SQ",
      "created_at": "2026-02-11T02:52:00.050Z",
      "author": "@claude",
      "content": "Implemented LoRA node with folder_paths dropdown (deferred import for testability). add_lora() returns RecipeLoRA with proper prev chaining for LoRA sets. Added 12 tests covering all 5 ACs: AC-1 (returns RecipeLoRA with path/strength), AC-2 (chaining via prev), AC-3 (folder_paths dropdown), AC-4 (no prev = single-element), AC-5 (zero strength preserved). Updated conftest.py mock for folder_paths.get_filename_list. All 119 tests pass, ruff clean."
    },
    {
      "task_ref": "01KH4HA47F",
      "task_title": "Implement Batched Pipeline Executor",
      "task_status": "pending_review",
      "note_ulid": "01KH4J3C",
      "created_at": "2026-02-10T19:57:51.325Z",
      "author": "@claude",
      "content": "NF-6 boundary clarification: This task implements the PRIMITIVES in lib/executor.py — OpSignature dataclass, DeltaSpec (in lib/types.py), compute_batch_size(), _apply_lora_set_batched_gpu() (LoRA apply via torch.bmm, LoKr via torch.kron), and OOM backoff wrapper. It does NOT implement the recipe tree walker — that is in @implement-exit-batched-evaluation. Key functions to port from scripts/lora_chain_merge.py: OpSignature (~line 50), DeltaSpec (~line 70), compute_batch_size() (~line 200), _apply_lora_set_batched_gpu() (~line 400). The evaluate_node_batched() tree walker (~line 850) belongs to the exit-batched-eval task."
    },
    {
      "task_ref": "01KH4HA47F",
      "task_title": "Implement Batched Pipeline Executor",
      "task_status": "pending_review",
      "note_ulid": "01KH4HA4",
      "created_at": "2026-02-10T19:44:03.311Z",
      "author": "@claude",
      "content": "Implementation notes:\n\nPort from ~/Projects/merge-router/scripts/lora_chain_merge.py. Key pieces:\nOpSignature frozen dataclass with affecting_sets (frozenset), shape (tuple),\nndim (int). DeltaSpec dataclass with fields for LoRA factors (up, down,\nscale, alpha, kind, rank, key_index). compute_batch_size(shape, n_models,\ndtype, free_vram) formula: B = floor(free_vram * 0.7 / (numel(shape) *\ndtype_bytes * (3 + 3 * n_models))). _apply_lora_set_batched_gpu(base_batch,\ndelta_specs, ...) -- partition specs by (kind, rank), stack up/down matrices,\ntorch.bmm(down, up) for standard LoRA, torch.kron per-key for LoKr, scatter\ndeltas back by key_index. OOM backoff: wrap chunk evaluation in try/except\ntorch.cuda.OutOfMemoryError, on catch call torch.cuda.empty_cache() and retry\nwith B=1. Define DeltaSpec in lib/types.py or lib/executor.py and import from\nlib/lora/ loaders. The executor is the main integration point -- it calls into\nlib/widen.py for WIDEN ops, lib/lora/*.py for LoRA loading, and walks the\nrecipe tree from lib/recipe.py.\nFiles: lib/executor.py, lib/types.py (for DeltaSpec/OpSignature if shared).\n"
    }
  ],
  "active_todos": [],
  "ready_tasks": [
    {
      "ref": "01KH4HA47M",
      "title": "Implement Architecture-Specific LoRA Loaders",
      "priority": 2,
      "spec_ref": "@lora-loaders",
      "tags": []
    },
    {
      "ref": "01KH4HA48P",
      "title": "Implement Block Config Type",
      "priority": 3,
      "spec_ref": "@block-config-type",
      "tags": []
    },
    {
      "ref": "01KH508VE1",
      "title": "Implement ComfyUI Mocking and Fixtures",
      "priority": 3,
      "spec_ref": "@comfyui-mocking",
      "tags": []
    }
  ],
  "blocked_tasks": [],
  "recently_completed": [
    {
      "ref": "01KH4HA473",
      "title": "Implement Exit Patch Installation",
      "completed_at": "2026-02-11T03:10:24.420Z",
      "closed_reason": "Merged in PR #9. Implemented install_merged_patches() helper with ModelPatcher cloning, diffusion_model. key prefixing, CPU transfer, and base dtype matching. Added IS_CHANGED classmethod using SHA-256 hash of LoRA file (path, mtime, size) tuples for cache invalidation. All 6 acceptance criteria covered by 26 tests."
    },
    {
      "ref": "01KH4HA46D",
      "title": "Implement Merge Node",
      "completed_at": "2026-02-11T03:04:40.091Z",
      "closed_reason": "Merged in PR #8. Implemented Merge node with base/target type validation. merge() validates base is RecipeBase or RecipeMerge (rejects RecipeLoRA/RecipeCompose with helpful error message suggesting Entry node or Merge output). All 6 ACs covered by 23 tests: AC-1 (RecipeMerge with fields), AC-2 (no backbone defaults None), AC-3 (backbone stored), AC-4 (merge chaining), AC-5 (invalid base rejection), AC-6 (t_factor -1.0 preserved). All tests pass, ruff clean."
    },
    {
      "ref": "01KH4HA46A",
      "title": "Implement Compose Node",
      "completed_at": "2026-02-11T02:58:53.235Z",
      "closed_reason": "Merged in PR #7. Implemented Compose node that accumulates branches for WIDEN merging. Uses RecipeCompose.with_branch() for persistent semantics. Validates branch types (accepts RecipeLoRA, RecipeCompose, RecipeMerge; rejects raw RecipeBase with helpful error). All 4 ACs covered by 17 tests."
    },
    {
      "ref": "01KH4HA467",
      "title": "Implement LoRA Node",
      "completed_at": "2026-02-11T02:54:03.844Z",
      "closed_reason": "Merged in PR #6. Implemented LoRA node with folder_paths dropdown, RecipeLoRA output with path/strength tuples, prev chaining for LoRA sets, and zero-strength preservation. All 5 ACs have test coverage (12 tests total)."
    },
    {
      "ref": "01KH4HA463",
      "title": "Implement Entry Node",
      "completed_at": "2026-02-11T02:49:00.440Z",
      "closed_reason": "Merged in PR #5. Implemented WIDEN Entry Node with architecture detection (SDXL, Z-Image supported; Flux/Qwen detected but unsupported). All 5 ACs covered by 17 tests. No GPU memory allocation or tensor copying."
    },
    {
      "ref": "01KH4HA47B",
      "title": "Implement WIDEN Core Algorithm",
      "completed_at": "2026-02-11T02:43:54.707Z",
      "closed_reason": "Merged in PR #4. Implemented WIDEN core algorithm port from merge-router with 5 modules (numerical_config.py, sparsity.py, ranking.py, divergence.py, widen.py). All 9 ACs covered with 32 tests: filter_delta zeros low-importance (AC-1), merge_weights routes via softmax (AC-2), batched variants match per-key (AC-3), no ComfyUI imports (AC-4), deterministic behavior (AC-5), fp16/bf16 use fp32 (AC-6), default config values (AC-7), filter_delta_batched fallback (AC-8), merge_weights_batched fallback (AC-9)."
    },
    {
      "ref": "01KH4HA460",
      "title": "Implement Recipe Type System",
      "completed_at": "2026-02-11T02:32:59.881Z",
      "closed_reason": "Merged in PR #3. Implemented recipe type system with frozen dataclasses, tuple fields, RecipeCompose.with_branch() for persistent tree semantics, RecipeNode type alias, and __all__ exports. All 5 ACs have test coverage: AC-1 (frozen), AC-2 (persistent semantics), AC-3 (no GPU tensors), AC-4 (importable/constructible), AC-5 (WIDEN wire connections)."
    },
    {
      "ref": "01KH508VF",
      "title": "Implement CI Pipeline",
      "completed_at": "2026-02-11T02:27:43.054Z",
      "closed_reason": "Merged in PR #2. Added GitHub Actions CI workflow with lint (ruff via astral-sh/ruff-action) and test (pytest with CPU-only PyTorch via uv) jobs. Triggers on push to main and all PRs. All ACs verified: ac-1 (pytest with CPU torch), ac-2 (ruff check), ac-3 (green checks on both jobs)."
    },
    {
      "ref": "01KH4H1VQK",
      "title": "Implement Testing Infrastructure",
      "completed_at": "2026-02-11T02:26:48.995Z",
      "closed_reason": "Merged in PR #1. Implemented testing infrastructure with: MockModelPatcher (4x4 float32 tensors, SDXL-like keys, model_state_dict/clone/add_patches/get_key_patches/patches_uuid), recipe fixtures (recipe_base, recipe_single_lora, recipe_multi_lora, recipe_compose, recipe_chain), autouse ComfyUI API mocks (folder_paths, comfy modules). All 37 tests pass without ComfyUI. All 4 ACs verified with test coverage."
    },
    {
      "ref": "01KH4H1VQF",
      "title": "Implement ComfyUI Packaging",
      "completed_at": "2026-02-11T02:25:41.782Z",
      "closed_reason": "Merged in PR #1. Implemented ComfyUI packaging infrastructure: NODE_CLASS_MAPPINGS with 5 WIDEN nodes, pyproject.toml with [tool.comfy] metadata (PublisherId=ecaj, DisplayName=ECAJ Nodes), lowercase ecaj/merge CATEGORY on all nodes, empty runtime deps with dev deps in optional-dependencies. All 4 ACs covered by tests in test_packaging.py."
    }
  ],
  "recent_commits": [
    {
      "hash": "b20b103",
      "full_hash": "b20b103bc12fa4d7ebb0acd7256a2ef8073b09e2",
      "date": "2026-02-11T03:15:51.000Z",
      "message": "feat: implement batched pipeline executor primitives",
      "author": "Jacob Chapel"
    },
    {
      "hash": "2f111b3",
      "full_hash": "2f111b3b3741d7c9bede30d314153b467945365f",
      "date": "2026-02-11T03:10:13.000Z",
      "message": "Merge pull request #9 from chapel/feat/exit-patch-install",
      "author": "Jacob Chapel"
    },
    {
      "hash": "27d3fe8",
      "full_hash": "27d3fe848dd56142b3fbb63f52bff114fa216945",
      "date": "2026-02-11T03:08:11.000Z",
      "message": "feat: implement exit patch installation with IS_CHANGED caching",
      "author": "Jacob Chapel"
    },
    {
      "hash": "e100108",
      "full_hash": "e100108b2b10782eb2f31a1af54b9e6326259ceb",
      "date": "2026-02-11T03:04:26.000Z",
      "message": "Merge pull request #8 from chapel/feat/merge-node",
      "author": "Jacob Chapel"
    },
    {
      "hash": "3f779ba",
      "full_hash": "3f779ba8cb99cb74571334e45557df4c354680d6",
      "date": "2026-02-11T03:02:04.000Z",
      "message": "feat: implement WIDEN Merge node with type validation",
      "author": "Jacob Chapel"
    },
    {
      "hash": "54ed110",
      "full_hash": "54ed110e30743106f5c115b7bcd013333b833e41",
      "date": "2026-02-11T02:58:44.000Z",
      "message": "Merge pull request #7 from chapel/feat/compose-node",
      "author": "Jacob Chapel"
    },
    {
      "hash": "c05c280",
      "full_hash": "c05c28050ac38b67fb2c4c020dc3726d41716e73",
      "date": "2026-02-11T02:56:57.000Z",
      "message": "feat: implement WIDEN Compose node with branch accumulation",
      "author": "Jacob Chapel"
    },
    {
      "hash": "6ff50c7",
      "full_hash": "6ff50c77da3e1e1f4ff38eb6fd398badb51651dc",
      "date": "2026-02-11T02:53:57.000Z",
      "message": "Merge pull request #6 from chapel/feat/lora-node",
      "author": "Jacob Chapel"
    },
    {
      "hash": "cecccbe",
      "full_hash": "cecccbee56790cd874947dc8c585a7a1476c1acb",
      "date": "2026-02-11T02:52:11.000Z",
      "message": "feat: implement WIDEN LoRA node with folder_paths dropdown",
      "author": "Jacob Chapel"
    },
    {
      "hash": "85598ca",
      "full_hash": "85598cadb1e1faceb84cd273ffaf639bbfaaa000",
      "date": "2026-02-11T02:48:53.000Z",
      "message": "Merge pull request #5 from chapel/feat/entry-node",
      "author": "Jacob Chapel"
    }
  ],
  "working_tree": {
    "clean": false,
    "staged": [],
    "unstaged": [],
    "untracked": [
      "uv.lock"
    ]
  },
  "inbox_items": [],
  "stats": {
    "total_tasks": 25,
    "in_progress": 0,
    "pending_review": 1,
    "ready": 3,
    "blocked": 0,
    "completed": 11,
    "inbox_items": 0
  }
}