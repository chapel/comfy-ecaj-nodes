{
  "generated_at": "2026-02-14T07:57:14.395Z",
  "branch": "feat/qwen-lora-loader",
  "context": {
    "focus": null,
    "threads": [],
    "open_questions": [],
    "updated_at": "2026-02-14T07:57:14.395Z"
  },
  "active_tasks": [],
  "pending_review_tasks": [
    {
      "ref": "01KHDHEGP",
      "title": "Implement Qwen LoRA loader",
      "started_at": "2026-02-14T07:51:52.341Z",
      "priority": 2,
      "spec_ref": null,
      "note_count": 2,
      "last_note_at": "2026-02-14T07:56:19.974Z",
      "todo_count": 0,
      "incomplete_todos": 0
    }
  ],
  "recent_notes": [
    {
      "task_ref": "01KHDHEGP",
      "task_title": "Implement Qwen LoRA loader",
      "task_status": "pending_review",
      "note_ulid": "01KHDJD4",
      "created_at": "2026-02-14T07:56:19.974Z",
      "author": "@claude",
      "content": "Implementation complete. Created lib/lora/qwen.py with QwenLoader class supporting 3 LoRA formats: diffusers (transformer.transformer_blocks.N.*.lora_A/B), A1111/kohya (lora_unet_transformer_blocks_N_*.lora_up/down), and LyCORIS (lycoris_transformer_blocks_N_*.lora_down/up). Key features: compound name preservation (_normalize_lycoris_key, _normalize_kohya_key), no QKV fusion (separate to_q/to_k/to_v), standard DeltaSpec production. Registered in LOADER_REGISTRY. Added 11 tests covering all 3 ACs (ac-4, ac-5, ac-6). 741 tests pass, ruff clean."
    },
    {
      "task_ref": "01KHDHEGN",
      "task_title": "Implement Qwen detection and block classification",
      "task_status": "completed",
      "note_ulid": "01KHDHS7",
      "created_at": "2026-02-14T07:45:27.611Z",
      "author": "@claude",
      "content": "Implementation complete. Added classify_key_qwen() to lib/block_classify.py mapping transformer_blocks.N to TB00+ with dynamic index discovery (regex, no upper bound). Added Qwen layer type patterns (_QWEN_LAYER_PATTERNS) for attention/feed_forward/norm classification. Registered in _CLASSIFIERS and _LAYER_TYPE_PATTERNS. Updated __all__. Added 'qwen' to _SUPPORTED_ARCHITECTURES in nodes/entry.py. Updated tests: test_qwen_detected_but_unsupported → test_qwen_detected_and_supported, removed qwen from unsupported arch test. Added TestBlockClassifyQwen (3 tests), test_returns_qwen_classifier, TestLayerTypeClassifyQwen (10 tests). All 729 tests pass, ruff clean."
    },
    {
      "task_ref": "01KHDHEGP",
      "task_title": "Implement Qwen LoRA loader",
      "task_status": "pending_review",
      "note_ulid": "01KHDHEG",
      "created_at": "2026-02-14T07:39:37.043Z",
      "author": "@claude",
      "content": "Create lib/lora/qwen.py implementing QwenLoader (subclass LoRALoader).\nHandle 3 LoRA formats -- diffusers, A1111/kohya, LyCORIS -- with\ncompound name preservation from merge-router reference\n(qwen_merge.py lines 254-283). No QKV fusion needed (separate\nto_q/to_k/to_v). Standard up/down DeltaSpec production.\nRegister in LOADER_REGISTRY in lib/lora/__init__.py.\n\nUpdate tests/test_lora_loaders.py: replace ValueError assertion for\nget_loader(\"qwen\") with real loader tests. Add new tests with\nsynthetic safetensors LoRA files for each format.\nCovers ac-4, ac-5, ac-6.\n"
    },
    {
      "task_ref": "01KHDHEGN",
      "task_title": "Implement Qwen detection and block classification",
      "task_status": "completed",
      "note_ulid": "01KHDHEG",
      "created_at": "2026-02-14T07:39:36.992Z",
      "author": "@claude",
      "content": "Enable Qwen detection in nodes/entry.py (add \"qwen\" to\n_SUPPORTED_ARCHITECTURES). Add classify_key_qwen() in\nlib/block_classify.py mapping transformer_blocks.N to TB00-TB59\nwith dynamic index discovery (regex, not hardcoded 60).\nAdd Qwen layer type patterns (attention/feed_forward/norm).\nRegister in _CLASSIFIERS and _LAYER_TYPE_PATTERNS.\nUpdate __all__ in block_classify.py to export new functions.\n\nBREAKING TESTS to update:\n- tests/test_entry.py: test_qwen_detected_but_unsupported (line 189)\n  must become test_qwen_detected_and_supported.\n- tests/test_layer_type_classify.py: assertions that qwen returns\n  None must become positive classification tests.\n- tests/test_merge_block_config.py: assertion that\n  get_block_classifier(\"qwen\") is None must test real classifier.\n- tests/test_lora_loaders.py: assertion that get_loader(\"qwen\")\n  raises ValueError must test real loader (covered by lora task).\n\nNew tests in: tests/test_entry.py, tests/test_layer_type_classify.py,\ntests/test_merge_block_config.py.\nCovers ac-1, ac-2, ac-3.\n"
    },
    {
      "task_ref": "01KHCJ41J",
      "task_title": "Implement Full Model Execution",
      "task_status": "completed",
      "note_ulid": "01KHD15E",
      "created_at": "2026-02-14T02:55:02.165Z",
      "author": "@claude",
      "content": "Implementation complete. Added full model execution support:\n\n**lib/analysis.py:**\n- Added RecipeModel case to walk_to_base (raises ValueError like RecipeLoRA)\n- Added RecipeModel skip case in _collect_lora_sets\n- Added ModelAnalysisResult dataclass\n- Added _collect_model_refs() to collect unique RecipeModel nodes\n- Added analyze_recipe_models() to open ModelLoader instances, validate architecture, build affected-key maps\n\n**lib/recipe_eval.py:**\n- Added OpApplyModel frozen dataclass with model_id, block_config, input_reg, out_reg\n- Added OpApplyModel to _Op type alias\n- Added OpApplyModel case to _input_regs()\n- Added model_id_map parameter to _PlanCompiler\n- Added _compile_model() method for RecipeModel -> OpApplyModel\n- Updated _compile_merge() to handle RecipeModel as valid target\n- Added model_id_map to compile_plan()\n- Added model_loaders parameter to execute_plan()\n- Added OpApplyModel handler in execute_plan() that loads weights from streaming loader\n- Added model_id_map and model_loaders to evaluate_recipe()\n\n**lib/persistence.py:**\n- Added RecipeModel case to serialize_recipe()\n- Added model_resolver parameter to compute_lora_stats()\n- Added RecipeModel handling in _walk() for file stats\n\n**nodes/exit.py:**\n- Added RecipeModel to imports\n- Added RecipeModel case in _validate_recipe_tree()\n- Added RecipeModel skip case in _collect_lora_paths()\n- Added _collect_model_paths() function\n- Added _build_model_resolver() function\n- Updated _compute_recipe_hash() to include model files (ac-11)\n- Updated IS_CHANGED to use model resolver\n- Updated execute() to call analyze_recipe_models()\n- Updated execute() to pass model_loaders and model_id_map to compile_plan/execute_plan\n- Added cleanup for model loaders in finally block\n\n**nodes/compose.py:**\n- Added RecipeModel as valid branch type\n\n**nodes/merge.py:**\n- Added RecipeModel as valid target type\n\n**tests/test_full_model_execution.py:**\n- Added 20 tests covering all 13 ACs\n\nAll 688 tests pass, ruff clean."
    },
    {
      "task_ref": "01KHCJ41H",
      "task_title": "Implement Full Model Loader",
      "task_status": "completed",
      "note_ulid": "01KHD0EW",
      "created_at": "2026-02-14T02:42:42.884Z",
      "author": "@claude",
      "content": "Implementation complete. Created lib/model_loader.py with ModelLoader class using safe_open() for memory-mapped access. Key features: key normalization (strips model.diffusion_model. and transformer. prefixes), excludes VAE/text encoder keys, architecture detection from normalized keys, get_weights() for batch tensor retrieval, cleanup() for resource release, UnsupportedFormatError for non-safetensors files. 27 tests covering all 9 ACs. Full suite passes, ruff clean."
    }
  ],
  "active_todos": [],
  "ready_tasks": [
    {
      "ref": "01KHDHEGR",
      "title": "Implement Qwen model loader support",
      "priority": 2,
      "spec_ref": null,
      "tags": [
        "qwen",
        "model-loader"
      ]
    },
    {
      "ref": "01KHDHEGT",
      "title": "Implement Flux Klein detection and block classification",
      "priority": 2,
      "spec_ref": null,
      "tags": [
        "flux",
        "classification"
      ]
    },
    {
      "ref": "01KHDHEGW",
      "title": "Implement Flux Klein model loader support",
      "priority": 2,
      "spec_ref": null,
      "tags": [
        "flux",
        "model-loader"
      ]
    }
  ],
  "blocked_tasks": [],
  "recently_completed": [
    {
      "ref": "01KHDHEGN",
      "title": "Implement Qwen detection and block classification",
      "completed_at": "2026-02-14T07:51:19.582Z",
      "closed_reason": "Merged in PR #55. Implemented Qwen architecture detection and block/layer-type classification. Added classify_key_qwen() mapping transformer_blocks.N to TB00+ with dynamic index discovery, Qwen layer type patterns for attention/feed_forward/norm classification (including img_mod/txt_mod), and registered in _CLASSIFIERS/_LAYER_TYPE_PATTERNS. Added 'qwen' to _SUPPORTED_ARCHITECTURES. All AC coverage verified: ac-1 (detection), ac-2 (block classification), ac-3 (layer type classification). 730 tests pass."
    },
    {
      "ref": "01KHC3H6",
      "title": "Add Qwen and Flux 2 Klein architecture support",
      "completed_at": "2026-02-14T07:39:50.714Z",
      "closed_reason": null
    },
    {
      "ref": "01KHCJ41J",
      "title": "Implement Full Model Execution",
      "completed_at": "2026-02-14T02:57:50.644Z",
      "closed_reason": "Merged in PR #54. Implemented full model execution for WIDEN checkpoint merging. Added RecipeModel support across the codebase: analyze_recipe_models() in lib/analysis.py, OpApplyModel in lib/recipe_eval.py, model path collection in nodes/exit.py, and RecipeModel as valid type in compose/merge nodes. All 13 ACs verified with 20 tests."
    },
    {
      "ref": "01KHCJ41H",
      "title": "Implement Full Model Loader",
      "completed_at": "2026-02-14T02:44:52.539Z",
      "closed_reason": "Merged in PR #53. Implemented ModelLoader class in lib/model_loader.py using safetensors safe_open() for memory-mapped checkpoint access. Key features: key normalization (strips model.diffusion_model. and transformer. prefixes), excludes VAE/text encoder keys, architecture detection from normalized keys, get_weights() for batch tensor retrieval, cleanup() for resource release, UnsupportedFormatError for non-safetensors files. All 9 ACs covered by 27 tests."
    },
    {
      "ref": "01KHCJ41G",
      "title": "Implement Model Input Node",
      "completed_at": "2026-02-14T02:39:35.284Z",
      "closed_reason": "Merged in PR #52. Implemented WIDENModelInputNode that produces RecipeModel from checkpoint file picker. Includes: checkpoint combo via folder_paths, strength slider (0.0-2.0), optional BLOCK_CONFIG input, returns WIDEN type. All 6 ACs covered by 15 tests."
    },
    {
      "ref": "01KHA77QE",
      "title": "Add layer-type filtering to block config",
      "completed_at": "2026-02-14T02:35:14.566Z",
      "closed_reason": "Merged in PR #51. Added layer-type filtering with classify_layer_type function supporting SDXL and Z-Image architectures. Layer types (attention, feed_forward, norm) apply multiplicatively with block overrides for both LoRA strength and WIDEN t_factor. UI sliders added to block config nodes. All 8 ACs covered with 897 lines of implementation and tests."
    },
    {
      "ref": "01KHCJ41F",
      "title": "Implement Full Model Recipe Type",
      "completed_at": "2026-02-14T02:23:52.069Z",
      "closed_reason": "Merged in PR #50. Added RecipeModel frozen dataclass to lib/recipe.py with path (str), strength (float, default 1.0), and block_config (BlockConfig | None) fields. Updated RecipeNode type alias. All 6 ACs covered by 17 tests."
    },
    {
      "ref": "01KHA77Q3",
      "title": "Refactor block config from grouped to individual blocks",
      "completed_at": "2026-02-14T02:19:17.185Z",
      "closed_reason": "Merged in PR #49. Refactored block config from grouped to individual blocks: SDXL 7→19 sliders (IN00-IN08, MID, OUT00-OUT08), Z-Image 8→34 sliders (L00-L29, NOISE_REF0-1, CTX_REF0-1). All 5 ACs covered with tests, CI passing."
    },
    {
      "ref": "01KHCQWY",
      "title": "Fix AC annotation style in test_graph.py",
      "completed_at": "2026-02-14T02:09:31.349Z",
      "closed_reason": "Merged in PR #48. Moved 17 AC annotations from docstring format to standard before-def comment format in test_graph.py. All 6 ACs (@node-graph-testing ac-1 through ac-6) have full test coverage."
    },
    {
      "ref": "01KHCRP1",
      "title": "Implement: Exit Model Persistence",
      "completed_at": "2026-02-14T02:03:37.720Z",
      "closed_reason": null
    }
  ],
  "recent_commits": [
    {
      "hash": "ee9e28c",
      "full_hash": "ee9e28c93a2791d453e35d9d305cc054c4d560f2",
      "date": "2026-02-14T07:56:36.000Z",
      "message": "feat: add Qwen LoRA loader for 3 formats",
      "author": "Jacob Chapel"
    },
    {
      "hash": "00c3525",
      "full_hash": "00c352568ca16675360e870b796365defbf273f2",
      "date": "2026-02-14T07:51:07.000Z",
      "message": "Merge pull request #55 from chapel/feat/qwen-detect-classify",
      "author": "Jacob Chapel"
    },
    {
      "hash": "06b9e55",
      "full_hash": "06b9e554beb8d15da1f1cf11f9676f7129686f02",
      "date": "2026-02-14T07:49:20.000Z",
      "message": "fix: add img_mod/txt_mod norm patterns to Qwen layer classification",
      "author": "Jacob Chapel"
    },
    {
      "hash": "228c7c3",
      "full_hash": "228c7c3265bf721def9586a60c58b70e93687fbb",
      "date": "2026-02-14T07:45:37.000Z",
      "message": "feat: add Qwen detection and block classification",
      "author": "Jacob Chapel"
    },
    {
      "hash": "3b18fd2",
      "full_hash": "3b18fd23f816e1da6b08e0772f969e8ddc5af11d",
      "date": "2026-02-14T02:57:42.000Z",
      "message": "Merge pull request #54 from chapel/feat/full-model-execution",
      "author": "Jacob Chapel"
    },
    {
      "hash": "da7d435",
      "full_hash": "da7d43527124d30bf097fdd9a1b849281aa853f4",
      "date": "2026-02-14T02:55:37.000Z",
      "message": "feat: add full model execution for WIDEN checkpoint merging",
      "author": "Jacob Chapel"
    },
    {
      "hash": "487651f",
      "full_hash": "487651fe06de54e25fa270d6dfd8bd2639d1cdde",
      "date": "2026-02-14T02:44:41.000Z",
      "message": "Merge pull request #53 from chapel/feat/model-loader",
      "author": "Jacob Chapel"
    },
    {
      "hash": "5848a71",
      "full_hash": "5848a7173517abdf4076c6591c6db169afe1ff57",
      "date": "2026-02-14T02:42:57.000Z",
      "message": "feat: add streaming model loader for full checkpoint merging",
      "author": "Jacob Chapel"
    },
    {
      "hash": "4cf82da",
      "full_hash": "4cf82da582ec18a6d81f54f076d1ee89176e8512",
      "date": "2026-02-14T02:39:26.000Z",
      "message": "Merge pull request #52 from chapel/feat/model-input-node",
      "author": "Jacob Chapel"
    },
    {
      "hash": "f58222a",
      "full_hash": "f58222a30e45aa4fb1a9e742e1a736fdee705f9b",
      "date": "2026-02-14T02:37:37.000Z",
      "message": "feat: add WIDEN Model Input node for full model merging",
      "author": "Jacob Chapel"
    }
  ],
  "working_tree": {
    "clean": true,
    "staged": [],
    "unstaged": [],
    "untracked": []
  },
  "inbox_items": [
    {
      "ref": "01KHCXS4",
      "text": "Recipe serialization as a trait/protocol — serialize_recipe currently uses isinstance checks for each recipe type. Should be a protocol method on RecipeNode so new recipe types implement their own serialization. Prevents silent skips and keeps persistence.py decoupled from recipe type enumeration.",
      "created_at": "2026-02-14T01:55:53.531Z",
      "tags": [],
      "added_by": "@claude"
    },
    {
      "ref": "01KHCXS7",
      "text": "compute_lora_stats._walk() silently ignores unknown recipe node types — should raise ValueError like serialize_recipe does. Related to serialization-as-trait refactor.",
      "created_at": "2026-02-14T01:55:56.494Z",
      "tags": [],
      "added_by": "@claude"
    },
    {
      "ref": "01KHCXS9",
      "text": "load_affected_keys should wrap safetensors errors with helpful message pointing to cached file corruption — tells users to delete and re-run.",
      "created_at": "2026-02-14T01:55:58.446Z",
      "tags": [],
      "added_by": "@claude"
    }
  ],
  "stats": {
    "total_tasks": 75,
    "in_progress": 0,
    "pending_review": 1,
    "ready": 4,
    "blocked": 0,
    "completed": 66,
    "inbox_items": 3
  }
}